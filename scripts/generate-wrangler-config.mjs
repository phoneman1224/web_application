#!/usr/bin/env node

/**
 * Generate wrangler.generated.toml from environment variables
 *
 * This script creates a complete wrangler configuration for TEST and PROD environments
 * based on environment variables and discovered Cloudflare resources.
 *
 * Required environment variables:
 * - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID
 *
 * Optional environment variables:
 * - DATABASE_ID_TEST: D1 database ID for test environment (auto-detected if not set)
 * - DATABASE_ID_PROD: D1 database ID for prod environment (auto-detected if not set)
 * - BUCKET_NAME_TEST: R2 bucket name for test (default: reseller-app-test)
 * - BUCKET_NAME_PROD: R2 bucket name for prod (default: reseller-app)
 */

import { execSync } from 'child_process';
import { writeFileSync } from 'fs';

// Get environment variables
const ACCOUNT_ID = process.env.CLOUDFLARE_ACCOUNT_ID;
const DB_ID_TEST = process.env.DATABASE_ID_TEST;
const DB_ID_PROD = process.env.DATABASE_ID_PROD;
const BUCKET_TEST = process.env.BUCKET_NAME_TEST || 'reseller-app-test';
const BUCKET_PROD = process.env.BUCKET_NAME_PROD || 'reseller-app';

if (!ACCOUNT_ID) {
  console.error('‚ùå Error: CLOUDFLARE_ACCOUNT_ID environment variable is required');
  process.exit(1);
}

console.log('üîß Generating wrangler configuration...');
console.log(`   Account ID: ${ACCOUNT_ID}`);

/**
 * Discover D1 database ID by name
 */
function discoverD1Database(name) {
  try {
    const output = execSync('wrangler d1 list --json', { encoding: 'utf-8' });
    const databases = JSON.parse(output);
    const db = databases.find(d => d.name === name);

    if (db) {
      console.log(`   ‚úÖ Found D1 database "${name}": ${db.uuid}`);
      return db.uuid;
    } else {
      console.log(`   ‚ö†Ô∏è  D1 database "${name}" not found (will need to be created)`);
      return null;
    }
  } catch (error) {
    console.log(`   ‚ö†Ô∏è  Could not list D1 databases (may not have wrangler configured)`);
    return null;
  }
}

/**
 * Get database IDs (from env vars or auto-discovery)
 */
const testDbId = DB_ID_TEST || discoverD1Database('reseller_app_test');
const prodDbId = DB_ID_PROD || discoverD1Database('reseller_app');

console.log(`   Test DB: ${testDbId || 'NOT SET'}`);
console.log(`   Prod DB: ${prodDbId || 'NOT SET'}`);
console.log(`   Test R2 Bucket: ${BUCKET_TEST}`);
console.log(`   Prod R2 Bucket: ${BUCKET_PROD}`);

/**
 * Generate wrangler.toml content
 */
const config = `# Generated wrangler configuration
# DO NOT EDIT THIS FILE MANUALLY - it is auto-generated by scripts/generate-wrangler-config.mjs
# To regenerate: npm run generate-config

name = "reseller-app"
main = "src/worker.ts"
compatibility_date = "2024-04-01"
account_id = "${ACCOUNT_ID}"

# Static assets
[site]
bucket = "./public"

# AI binding (Cloudflare Workers AI)
[ai]
binding = "AI"

# Global variables
[vars]
APP_NAME = "Reseller Ops"

# ============================================
# TEST ENVIRONMENT
# ============================================
[env.test]
name = "reseller-app-test"
route = { pattern = "test.markbrian5178.org/*", zone_name = "markbrian5178.org" }

# Test D1 Database
${testDbId ? `[[env.test.d1_databases]]
binding = "DB"
database_name = "reseller_app_test"
database_id = "${testDbId}"` : '# D1 database not configured - run provision script'}

# Test R2 Bucket
[[env.test.r2_buckets]]
binding = "RECEIPTS"
bucket_name = "${BUCKET_TEST}"

[env.test.vars]
ENVIRONMENT = "test"

# ============================================
# PRODUCTION ENVIRONMENT
# ============================================
[env.production]
name = "reseller-app"
route = { pattern = "app.markbrian5178.org/*", zone_name = "markbrian5178.org" }

# Production D1 Database
${prodDbId ? `[[env.production.d1_databases]]
binding = "DB"
database_name = "reseller_app"
database_id = "${prodDbId}"` : '# D1 database not configured - run provision script'}

# Production R2 Bucket
[[env.production.r2_buckets]]
binding = "RECEIPTS"
bucket_name = "${BUCKET_PROD}"

[env.production.vars]
ENVIRONMENT = "production"
`;

// Write the generated configuration
try {
  writeFileSync('wrangler.generated.toml', config);
  console.log('‚úÖ Generated wrangler.generated.toml');

  // Warnings
  if (!testDbId || !prodDbId) {
    console.log('\n‚ö†Ô∏è  Warning: Some database IDs are missing.');
    console.log('   Run the provision script to create D1 databases:');
    console.log('   node scripts/provision-cf.mjs --env test');
    console.log('   node scripts/provision-cf.mjs --env production');
  }

  console.log('\n‚úÖ Configuration generated successfully!');
  console.log('   You can now deploy with:');
  console.log('   npm run deploy:test');
  console.log('   npm run deploy:prod');
} catch (error) {
  console.error('‚ùå Error writing configuration file:', error.message);
  process.exit(1);
}
